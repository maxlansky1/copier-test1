name: Render PlantUML diagrams

# üìå –¢—Ä–∏–≥–≥–µ—Ä: –∑–∞–ø—É—Å–∫–∞—Ç—å workflow –ø—Ä–∏ push –Ω–∞ –≤–µ—Ç–∫—É main –∏–ª–∏ –ª—é–±—É—é –¥—Ä—É–≥—É—é –≤–µ—Ç–∫—É
on:
  push:
    branches:
      - main
      - '**'  # –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –≤—Å–µ—Ö –≤–µ—Ç–æ–∫ ‚Äî —É–¥–æ–±–Ω–æ –¥–ª—è —Ç–µ—Å—Ç–æ–≤ –Ω–∞ —Ñ–∏—á–µ-–≤–µ—Ç–∫–∞—Ö

jobs:
  render:
    runs-on: ubuntu-latest  # ‚òÅÔ∏è –ò—Å–ø–æ–ª—å–∑—É–µ–º –≤–∏—Ä—Ç—É–∞–ª—å–Ω—É—é –º–∞—à–∏–Ω—É Ubuntu –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è CI

    steps:
    # üîΩ 1. –ö–ª–æ–Ω–∏—Ä—É–µ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é —Ç–æ–ª—å–∫–æ –æ–¥–Ω—É –≤–µ—Ç–∫—É)
    - name: Checkout repository (branch main)
      uses: actions/checkout@v3
      with:
        ref: main

    # üß± 2. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –≤—Ä–µ–º–µ–Ω–Ω–æ–π –¥–∏–∞–≥—Ä–∞–º–º—ã temp_containers.puml —Å –Ω–æ–≤—ã–º–∏ —Ñ–∞–π–ª–∞–º–∏
    # –ò—Å–ø–æ–ª—å–∑—É–µ—Ç tools/diagrams_auto_update.py, –∫–æ—Ç–æ—Ä—ã–π —Å–∫–∞–Ω–∏—Ä—É–µ—Ç git –∏ —Å–æ–∑–¥–∞–µ—Ç C4-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
    - name: Generate temp_containers.puml from new files
      run: |
        python3 tools/diagrams_auto_update.py

    # ‚òï 3. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏: Java (–¥–ª—è PlantUML) –∏ Graphviz (–¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ —Ä–µ–Ω–¥–µ—Ä–∞)
    - name: Install Java and Graphviz
      run: |
        sudo apt-get update
        sudo apt-get install -y default-jre graphviz

    # üì• 4. –°–∫–∞—á–∏–≤–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω—é—é –≤–µ—Ä—Å–∏—é PlantUML
    - name: Download latest PlantUML jar
      run: |
        echo "Downloading latest PlantUML.jar"
        wget -q https://github.com/plantuml/plantuml/releases/latest/download/plantuml.jar -O plantuml.jar
        java -jar plantuml.jar -version

    # üîé 5. –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω–∞–π–¥–µ–Ω–Ω—ã–µ .puml —Ñ–∞–π–ª—ã (–∏—Å–∫–ª—é—á–∞—è –±–∞–∑–æ–≤—ã–µ —à–∞–±–ª–æ–Ω—ã C4-–º–æ–¥–µ–ª–µ–π)
    - name: List all .puml files (excluding C4_Context.puml and C4_Container.puml)
      run: |
        echo "=== Found .puml files ==="
        find . -name '*.puml' ! -name 'C4_Context.puml' ! -name 'C4_Container.puml'

    # üñºÔ∏è 6. –†–µ–Ω–¥–µ—Ä–∏–º –≤—Å–µ .puml –≤ .svg (–≤ –ø–∞–ø–∫–µ diagrams) —Å –º–∞—Å—à—Ç–∞–±–æ–º –∏ –ª–æ–≥–∞–º–∏
    - name: Render PlantUML diagrams to PNG with verbose logging
      run: |
        echo "=== Rendering diagrams ==="
        find diagrams -name '*.puml' | while read file; do
          echo "Rendering $file"
          java -jar plantuml.jar -tsvg -scale 2.0 -verbose "$file" || { echo "Error rendering $file"; exit 1; }
        done
        echo "=== Rendered PNG files ==="
        find . -name '*.svg'

    # üíæ 7. Git-–∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∏ –∫–æ–º–º–∏—Ç –≤—Å–µ—Ö –Ω–æ–≤—ã—Ö –∏–ª–∏ –∏–∑–º–µ–Ω—ë–Ω–Ω—ã—Ö .svg (–µ—Å–ª–∏ –µ—Å—Ç—å)
    - name: Git config and commit rendered images
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        echo "=== Git status before adding ==="
        git status

        # –î–æ–±–∞–≤–ª—è–µ–º –≤—Å–µ –æ—Ç—Ä–µ–Ω–¥–µ—Ä–µ–Ω–Ω—ã–µ SVG-—Ñ–∞–π–ª—ã –∏ –≤—Ä–µ–º–µ–Ω–Ω—É—é –¥–∏–∞–≥—Ä–∞–º–º—É
        git add diagrams/temp_containers.puml
        git add $(find diagrams -name '*.svg' 2>/dev/null || echo "")

        if git diff --cached --quiet; then
          echo "No changes to commit"
        else
          echo "Changes detected, committing..."
          git commit -m "Auto-render PlantUML diagrams"
          echo "Committed!"
        fi

        echo "=== Git status after commit attempt ==="
        git status

    # üöÄ 8. –ü—É—à–∏–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –æ–±—Ä–∞—Ç–Ω–æ –≤ –≤–µ—Ç–∫—É main
    - name: Push changes to branch main
      uses: ad-m/github-push-action@v0.6.0
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        branch: main
