name: Build and Deploy Docs with PlantUML

on:
  push:
    branches:
      - main
      - '**'  # –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –≤—Å–µ—Ö –≤–µ—Ç–æ–∫ ‚Äî —É–¥–æ–±–Ω–æ –¥–ª—è —Ç–µ—Å—Ç–æ–≤ –Ω–∞ —Ñ–∏—á–µ-–≤–µ—Ç–∫–∞—Ö

jobs:
  build-deploy:
    runs-on: ubuntu-latest

    steps:
      # üîΩ 1. –ö–ª–æ–Ω–∏—Ä—É–µ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
      - name: Checkout repository
        uses: actions/checkout@v3

      # üß± 2. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –≤—Ä–µ–º–µ–Ω–Ω–æ–π –¥–∏–∞–≥—Ä–∞–º–º—ã temp_containers.puml
      - name: Generate temp_containers.puml from new files (if script exists)
        if: success() && github.ref != 'refs/heads/main'
        run: |
          if [ -f tools/diagram_auto_update.py ]; then
            python3 tools/diagram_auto_update.py
          else
            echo "tools/diagram_auto_update.py not found, skipping diagram generation"
          fi

      # ‚òï 3. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Java –∏ Graphviz
      - name: Install Java and Graphviz
        run: |
          sudo apt-get update
          sudo apt-get install -y default-jre graphviz

      # üì• 4. –°–∫–∞—á–∏–≤–∞–µ–º PlantUML
      - name: Download latest PlantUML jar
        run: |
          wget -q https://github.com/plantuml/plantuml/releases/latest/download/plantuml.jar  -O plantuml.jar
          java -jar plantuml.jar -version

      # üñºÔ∏è 5. –†–µ–Ω–¥–µ—Ä–∏–º –≤—Å–µ .puml –≤ .svg (–≤ –ø–∞–ø–∫–µ diagrams)
      - name: Render PlantUML diagrams to SVG
        run: |
          echo "=== Rendering PlantUML diagrams ==="
          find diagrams -name '*.puml' | while read file; do
            echo "Rendering $file"
            java -jar plantuml.jar -tsvg -scale 2.0 "$file" || { echo "Error rendering $file"; exit 1; }
          done
          echo "=== Rendered SVG files ==="
          find diagrams -name '*.svg'

      # üíæ 6. Git-–∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∏ –∫–æ–º–º–∏—Ç –Ω–æ–≤—ã—Ö/–∏–∑–º–µ–Ω—ë–Ω–Ω—ã—Ö svg
      - name: Commit rendered images
        id: git_commit
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add diagrams/*.svg diagrams/temp_containers.puml

          if git diff --cached --quiet; then
            echo "No changes to commit"
            echo "::set-output name=changes::false"
          else
            echo "Changes detected, committing..."
            git commit -m "Auto-render PlantUML diagrams"
            echo "::set-output name=changes::true"
          fi

      # üöÄ 7. –ü—É—à–∏–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –æ–±—Ä–∞—Ç–Ω–æ (–µ—Å–ª–∏ –±—ã–ª–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è)
      - name: Push changes to branch
        if: steps.git_commit.outputs.changes == 'true'
        uses: ad-m/github-push-action@v0.6.0
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ github.ref }}

      # üêç 8. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Python –∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install sphinxcontrib-plantuml

      # üìò 9. –°–±–æ—Ä–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏
      - name: Build documentation
        run: |
          cd docs && make html

      # üåê 10. –ü—É–±–ª–∏–∫–∞—Ü–∏—è –Ω–∞ GitHub Pages
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./docs/_build/html
          